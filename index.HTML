<script type="module">
// ===== SUPABASE INIT =====
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.0/+esm';
const supabaseUrl = 'https://skejswjowceevzkloiog.supabase.co';
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNrZWpzd2pvd2NlZXZ6a2xvaW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNDg0NDYsImV4cCI6MjA3NjYyNDQ0Nn0.Q9LSKeEkOO7FZv3SOKvJa8efksRfGFYrvZDKlQmKTqk';
const supabase = createClient(supabaseUrl, supabaseAnonKey);

let incomeRecords = [];
let expenseRecords = [];

// Fetch records
async function fetchRecords() {
  const [incRes, expRes] = await Promise.all([
    supabase.from('income').select('*').order('date', { ascending: false }),
    supabase.from('expenses').select('*').order('date', { ascending: false })
  ]);
  if (incRes.error) console.error('Income fetch error:', incRes.error);
  else incomeRecords = incRes.data || [];
  if (expRes.error) console.error('Expenses fetch error:', expRes.error);
  else expenseRecords = expRes.data || [];
}

// Format MVR
function formatMVR(n) {
  return (Number(n) || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + ' MVR';
}

// Date filter
function isInDateRange(dateStr, { from, to }) {
  if (!from && !to) return true;
  const d = new Date(dateStr);
  if (from && d < new Date(from)) return false;
  if (to && d > new Date(to)) return false;
  return true;
}

// Compute totals
function computeTotals(filter = {}) {
  const inc = incomeRecords.filter(r => isInDateRange(r.date, filter));
  const exp = expenseRecords.filter(r => isInDateRange(r.date, filter));
  const totalIncome = inc.reduce((s, r) => s + r.amount, 0);
  const totalExpenses = exp.reduce((s, r) => s + r.amount, 0);
  return { totalIncome, totalExpenses, netProfit: totalIncome - totalExpenses };
}

// Dashboard chart
let summaryBarChart = null;
function renderDashboard() {
  const filter = {
    from: document.getElementById('dashboardFrom').value,
    to: document.getElementById('dashboardTo').value
  };
  const { totalIncome, totalExpenses, netProfit } = computeTotals(filter);
  document.getElementById('totalIncomeEl').textContent = formatMVR(totalIncome);
  const expEl = document.getElementById('totalExpensesEl');
  expEl.textContent = formatMVR(totalExpenses);
  expEl.style.color = 'var(--danger)'; // ðŸ”´ Always red for expenses per your preference
  const netEl = document.getElementById('netProfitEl');
  netEl.textContent = formatMVR(netProfit);
  netEl.style.color = netProfit >= 0 ? 'var(--success)' : 'var(--danger)';

  const ctx = document.getElementById('summaryBarChart')?.getContext('2d');
  if (ctx) {
    if (summaryBarChart) summaryBarChart.destroy();
    summaryBarChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Sale', 'Expenses'],
        datasets: [{
          label: 'Amount (MVR)',
          data: [totalIncome, totalExpenses],
          backgroundColor: ['#2fb6ac', '#ff6b6b'],
          borderWidth: 0,
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.dataset.label}: ${formatMVR(ctx.parsed.y)}`
            }
          }
        },
        scales: {
          x: { grid: { display: false } },
          y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.04)' } }
        }
      }
    });
  }
}

// Render income table
function renderIncome() {
  const tbody = document.querySelector('#incomeTable tbody');
  const filter = {
    from: document.getElementById('incomeFrom')?.value,
    to: document.getElementById('incomeTo')?.value
  };
  const filtered = incomeRecords.filter(r => isInDateRange(r.date, filter));
  tbody.innerHTML = filtered.length
    ? filtered.map(r => `
        <tr data-id="${r.id}" data-type="income">
          <td>${r.date}</td>
          <td>${r.description}</td>
          <td>${r.payment}</td>
          <td style="color:var(--success)">${formatMVR(r.amount)}</td>
          <td class="table-actions">
            <button class="btn small secondary invoice-btn" data-id="${r.id}">Invoice</button>
            <button class="btn small secondary edit-btn" data-id="${r.id}">Edit</button>
            <button class="btn small danger delete-btn" data-id="${r.id}">Delete</button>
          </td>
        </tr>`).join('')
    : `<tr><td colspan="5" class="empty-state">No sale records</td></tr>`;
  const total = filtered.reduce((s, r) => s + r.amount, 0);
  document.getElementById('incomeTotalFooter').textContent = formatMVR(total);
}

// Render expenses table
function renderExpenses() {
  const tbody = document.querySelector('#expensesTable tbody');
  const filter = {
    from: document.getElementById('expensesFrom')?.value,
    to: document.getElementById('expensesTo')?.value
  };
  const filtered = expenseRecords.filter(r => isInDateRange(r.date, filter));
  tbody.innerHTML = filtered.length
    ? filtered.map(r => `
        <tr data-id="${r.id}" data-type="expense">
          <td>${r.date}</td>
          <td>${r.description}</td>
          <td>${r.payment}</td>
          <td style="color:var(--danger)">${formatMVR(r.amount)}</td>
          <td class="table-actions">
            <button class="btn small secondary edit-btn" data-id="${r.id}">Edit</button>
            <button class="btn small danger delete-btn" data-id="${r.id}">Delete</button>
          </td>
        </tr>`).join('')
    : `<tr><td colspan="5" class="empty-state">No expense records</td></tr>`;
  const total = filtered.reduce((s, r) => s + r.amount, 0);
  document.getElementById('expensesTotalFooter').textContent = formatMVR(total);
}

// Generate invoice
function generateInvoice(id) {
  const r = incomeRecords.find(rec => rec.id === id);
  if (!r) return;
  const invoiceNum = `INV-${new Date().getTime().toString().slice(-6)}`;
  document.getElementById('invoiceNumber').textContent = invoiceNum;
  document.getElementById('invoiceDate').textContent = r.date;
  document.getElementById('invoiceDesc').textContent = r.description;
  document.getElementById('invoicePayment').textContent = r.payment;
  document.getElementById('invoiceItemDesc').textContent = r.description;
  document.getElementById('invoiceAmount').textContent = formatMVR(r.amount);
  document.getElementById('invoiceTotal').textContent = formatMVR(r.amount);
  document.getElementById('invoiceModal').style.display = 'flex';
}

// Delete record
async function deleteRecord(id, type) {
  if (!confirm(`Delete this ${type}?`)) return;
  const table = type === 'income' ? 'income' : 'expenses';
  const { error } = await supabase.from(table).delete().eq('id', id);
  if (error) { alert('Failed to delete'); console.error(error); }
  else {
    if (type === 'income') {
      incomeRecords = incomeRecords.filter(r => r.id !== id);
      renderIncome();
    } else {
      expenseRecords = expenseRecords.filter(r => r.id !== id);
      renderExpenses();
    }
    renderDashboard();
  }
}

// Open edit modal (reusable)
function openEditModal(id, type) {
  const records = type === 'income' ? incomeRecords : expenseRecords;
  const r = records.find(rec => rec.id === id);
  if (!r) return;

  const modal = document.createElement('div');
  modal.className = 'modal-backdrop';
  modal.innerHTML = `
    <div class="modal">
      <button class="close-modal">Ã—</button>
      <h3>Edit ${type === 'income' ? 'Sale' : 'Expense'}</h3>
      <div class="field"><label>Date</label><input type="date" id="m_date" value="${r.date}"></div>
      <div class="field"><label>Description</label><input id="m_desc" value="${r.description}"></div>
      <div class="field"><label>Payment</label>
        <select id="m_pay">
          <option value="Cash" ${r.payment === 'Cash' ? 'selected' : ''}>Cash</option>
          <option value="Transfer" ${r.payment === 'Transfer' ? 'selected' : ''}>Transfer</option>
        </select>
      </div>
      <div class="field"><label>Amount (MVR)</label><input type="number" id="m_amt" value="${r.amount}" step="0.01" min="0"></div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:16px;">
        <button class="btn secondary cancel-btn">Cancel</button>
        <button class="btn save-btn" data-id="${id}" data-type="${type}">Save</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  const closeModal = () => modal.remove();
  modal.querySelector('.close-modal').addEventListener('click', closeModal);
  modal.querySelector('.cancel-btn').addEventListener('click', closeModal);
  modal.querySelector('.save-btn').addEventListener('click', async (e) => {
    const btn = e.target;
    const id = btn.dataset.id;
    const type = btn.dataset.type;
    const table = type === 'income' ? 'income' : 'expenses';
    const date = modal.querySelector('#m_date').value;
    const desc = modal.querySelector('#m_desc').value.trim();
    const payment = modal.querySelector('#m_pay').value;
    const amount = parseFloat(modal.querySelector('#m_amt').value) || 0;
    if (!date || !desc || amount <= 0) {
      alert('Please fill all fields with valid values.');
      return;
    }
    const { error } = await supabase
      .from(table)
      .update({ date, description: desc, payment, amount })
      .eq('id', id);
    if (error) {
      alert('Failed to update: ' + (error.message || 'Unknown error'));
      console.error(error);
    } else {
      const arr = type === 'income' ? incomeRecords : expenseRecords;
      const idx = arr.findIndex(rec => rec.id === id);
      if (idx !== -1) arr[idx] = { ...arr[idx], date, description: desc, payment, amount };
      if (type === 'income') renderIncome(); else renderExpenses();
      renderDashboard();
      closeModal();
    }
  });
}

// Delegated event listener for actions (critical for mobile reliability)
document.getElementById('content').addEventListener('click', (e) => {
  const btn = e.target.closest('.invoice-btn, .edit-btn, .delete-btn');
  if (!btn) return;
  const id = parseInt(btn.dataset.id);
  const row = btn.closest('tr');
  const type = row ? row.dataset.type : 'income';

  if (btn.classList.contains('invoice-btn')) {
    generateInvoice(id);
  } else if (btn.classList.contains('edit-btn')) {
    openEditModal(id, type);
  } else if (btn.classList.contains('delete-btn')) {
    deleteRecord(id, type);
  }
});

// Add income modal
document.getElementById('addIncomeBtn')?.addEventListener('click', () => {
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop';
  modal.innerHTML = `
    <div class="modal">
      <button class="close-modal">Ã—</button>
      <h3>Add Sale</h3>
      <div class="field"><label>Date</label><input type="date" id="m_date" value="${new Date().toISOString().slice(0,10)}"></div>
      <div class="field"><label>Description</label><input id="m_desc" placeholder="e.g. Product Sale"></div>
      <div class="field"><label>Payment</label>
        <select id="m_pay"><option>Cash</option><option>Transfer</option></select>
      </div>
      <div class="field"><label>Amount (MVR)</label><input type="number" id="m_amt" value="0" step="0.01" min="0"></div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:16px;">
        <button class="btn secondary cancel-btn">Cancel</button>
        <button class="btn save-new" data-type="income">Add</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  const closeModal = () => modal.remove();
  modal.querySelector('.close-modal').addEventListener('click', closeModal);
  modal.querySelector('.cancel-btn').addEventListener('click', closeModal);
  modal.querySelector('.save-new').addEventListener('click', async () => {
    const date = modal.querySelector('#m_date').value;
    const desc = modal.querySelector('#m_desc').value.trim() || 'Sale';
    const payment = modal.querySelector('#m_pay').value;
    const amount = parseFloat(modal.querySelector('#m_amt').value) || 0;
    if (!date || amount <= 0) { alert('Invalid input'); return; }
    const { data, error } = await supabase.from('income').insert([{ date, description: desc, payment, amount }]).select();
    if (error) { alert('Failed: ' + error.message); console.error(error); }
    else { incomeRecords.unshift(data[0]); renderIncome(); renderDashboard(); closeModal(); }
  });
});

// Add expense modal
document.getElementById('addExpenseBtn')?.addEventListener('click', () => {
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop';
  modal.innerHTML = `
    <div class="modal">
      <button class="close-modal">Ã—</button>
      <h3>Add Expense</h3>
      <div class="field"><label>Date</label><input type="date" id="m_date" value="${new Date().toISOString().slice(0,10)}"></div>
      <div class="field"><label>Description</label><input id="m_desc" placeholder="e.g. Office Supplies"></div>
      <div class="field"><label>Payment</label>
        <select id="m_pay"><option>Cash</option><option>Transfer</option></select>
      </div>
      <div class="field"><label>Amount (MVR)</label><input type="number" id="m_amt" value="0" step="0.01" min="0"></div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:16px;">
        <button class="btn secondary cancel-btn">Cancel</button>
        <button class="btn save-new" data-type="expense">Add</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  const closeModal = () => modal.remove();
  modal.querySelector('.close-modal').addEventListener('click', closeModal);
  modal.querySelector('.cancel-btn').addEventListener('click', closeModal);
  modal.querySelector('.save-new').addEventListener('click', async () => {
    const date = modal.querySelector('#m_date').value;
    const desc = modal.querySelector('#m_desc').value.trim() || 'Expense';
    const payment = modal.querySelector('#m_pay').value;
    const amount = parseFloat(modal.querySelector('#m_amt').value) || 0;
    if (!date || amount <= 0) { alert('Invalid input'); return; }
    const { data, error } = await supabase.from('expenses').insert([{ date, description: desc, payment, amount }]).select();
    if (error) { alert('Failed: ' + error.message); console.error(error); }
    else { expenseRecords.unshift(data[0]); renderExpenses(); renderDashboard(); closeModal(); }
  });
});

// Export CSV
function exportCsv(filename, records) {
  if (!records.length) { alert('No data to export'); return; }
  const headers = ['Date','Description','Payment','Amount'];
  const csv = [headers, ...records.map(r => [r.date, r.description, r.payment, r.amount])]
    .map(row => row.map(v => `"${String(v).replace(/"/g, '""')}"`).join(','))
    .join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), { href: url, download: filename });
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
document.getElementById('exportIncomeCsv')?.addEventListener('click', () => exportCsv('sale.csv', incomeRecords));
document.getElementById('exportExpensesCsv')?.addEventListener('click', () => exportCsv('expenses.csv', expenseRecords));

// Navigation
document.querySelectorAll('.nav a').forEach(a => {
  a.addEventListener('click', e => {
    e.preventDefault();
    document.querySelectorAll('.nav a').forEach(x => x.classList.remove('active'));
    a.classList.add('active');
    const page = a.dataset.page;
    document.querySelectorAll('.page').forEach(sec => {
      sec.style.display = sec.id === `page-${page}` ? 'block' : 'none';
    });
  });
});

// Filter handlers
['dashboard','income','expenses'].forEach(p => {
  const prefix = p.charAt(0).toUpperCase() + p.slice(1);
  document.getElementById(`apply${prefix}Filter`)?.addEventListener('click', () => {
    p === 'dashboard' ? renderDashboard() : (p === 'income' ? renderIncome() : renderExpenses());
  });
  document.getElementById(`clear${prefix}Filter`)?.addEventListener('click', () => {
    document.getElementById(`${p}From`).value = '';
    document.getElementById(`${p}To`).value = '';
    p === 'dashboard' ? renderDashboard() : (p === 'income' ? renderIncome() : renderExpenses());
  });
});

// Close invoice modal on click outside
document.getElementById('invoiceModal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('invoiceModal')) {
    document.getElementById('invoiceModal').style.display = 'none';
  }
});

// Init
(async () => {
  await fetchRecords();
  renderDashboard();
  renderIncome();
  renderExpenses();
})();
</script>
