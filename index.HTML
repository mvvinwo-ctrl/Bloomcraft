
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Bloomkraft — Business Portal (MVR)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js  "></script>
  <style>
    :root{
      --turquoise: #2fb6ac;
      --coral: #ff7b6b;
      --bg: #fbfdfe;
      --card: #ffffff;
      --muted: #6b7280;
      --accent-text: #07303a;
      --success: #18a39e;
      --danger: #ff6b6b;
      --radius: 16px;
      --container-w: 1100px;
      --shadow: 0 8px 24px rgba(3, 20, 24, 0.08);
      --stat-bg: #f9fdfd;
      font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{
      height:100%;
      margin:0;
      background: linear-gradient(180deg, #f5fbfb, #fbfdfe);
      color: #0f1724;
      overflow-x: hidden;
    }
    .app{
      max-width: var(--container-w);
      margin: 0 auto;
      background: var(--card);
      border-radius: 0px; /* Full-width mobile */
      box-shadow: var(--shadow);
      overflow: hidden;
      width: 100vw;
      padding: 0;
    }
    header{
      display:flex;
      align-items:center;
      gap:12px;
      background: linear-gradient(90deg, var(--turquoise), #37c6bf 70%);
      color: #fff;
      padding:12px 16px;
      flex-wrap: wrap;
      justify-content: space-between;
      position: relative;
      z-index: 100;
    }
    .logo{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      font-size:18px;
      letter-spacing:0.3px;
    }
    .nav{
      display:flex;
      gap:8px;
      margin-left:12px;
      align-items:center;
      font-weight:600;
      opacity:0.95;
      flex-wrap: wrap;
    }
    .nav a{
      text-decoration:none;
      color: rgba(255,255,255,0.95);
      padding:6px 10px;
      border-radius:8px;
      font-size:14px;
      white-space: nowrap;
    }
    .nav a.active{ 
      background: rgba(255,255,255,0.15); 
      border-radius: 20px;
    }
    main{
      display:flex;
      flex-direction: column;
      gap:16px;
      padding:16px;
      width: 100%;
      box-sizing: border-box;
    }
    .card{
      background: var(--card);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.04);
      border: 1px solid rgba(0,0,0,0.03);
      width: 100%;
      box-sizing: border-box;
    }
    .big-stats{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap:12px;
      width: 100%;
    }
    .stat{
      background: var(--stat-bg);
      padding:16px;
      border-radius: var(--radius);
      text-align: center;
      border: 1px solid rgba(47,182,172,0.1);
    }
    .stat h4{ 
      margin:0; 
      color:var(--muted); 
      font-weight:600; 
      font-size:14px;
      line-height: 1.4;
    }
    .stat .value{ 
      margin-top:8px; 
      font-size:22px;
      font-weight:800; 
      color:var(--accent-text); 
      word-wrap: break-word;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }
    thead th{
      text-align:left;
      padding:10px 8px;
      color:var(--muted);
      font-weight:700;
      border-bottom: 2px solid rgba(0,0,0,0.06);
      white-space: nowrap;
    }
    tbody td{
      padding:10px 8px;
      border-bottom: 1px solid rgba(15,23,36,0.06);
      color:#0f1724;
      word-wrap: break-word;
    }
    tfoot td{
      padding:8px 8px;
      font-weight:700;
      background: var(--stat-bg);
      border-top: 2px solid rgba(0,0,0,0.08);
    }
    .page-title{
      font-size:26px;
      font-weight:800;
      margin:0 0 16px 0;
      color:var(--accent-text);
      word-wrap: break-word;
    }
    .controls{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:16px;
      flex-wrap: wrap;
      width: 100%;
    }
    .date-filters {
      display: flex;
      gap:8px;
      align-items: center;
      flex-wrap: wrap;
      width: 100%;
    }
    .date-filters label {
      font-weight:600;
      color: var(--muted);
      font-size:13px;
      white-space: nowrap;
    }
    .date-filters input[type="date"] {
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:8px;
      font-size:14px;
      background: #fff;
      min-width: 120px;
      width: 100%;
      max-width: 140px;
    }
    .date-filters button {
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 8px;
      min-width: 80px;
      width: 100%;
      max-width: 120px;
      text-align: center;
    }
    .btn{
      background:var(--turquoise);
      color:#fff;
      border:none;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      white-space:nowrap;
      font-size:14px;
      min-width: 80px;
      text-align: center;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .btn.secondary{
      background:#f3f6f7;
      color: var(--accent-text);
      border:1px solid rgba(15,23,36,0.08);
    }
    .btn.danger{ 
      background:var(--coral); 
    }
    .btn.small {
      padding: 7px 12px;
      font-size: 13px;
      border-radius:8px;
      min-width: auto;
    }
    /* MOBILE OPTIMIZED */
    @media (max-width: 768px){
      .app {
        border-radius: 0 !important;
        margin: 0 !important;
      }
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      .date-filters {
        flex-direction: column;
        gap: 8px;
        width: 100%;
      }
      .date-filters input[type="date"] {
        min-width: 100%;
        max-width: 100%;
      }
      .nav {
        gap: 6px;
        font-size: 13px;
      }
      .big-stats {
        grid-template-columns: 1fr;
      }
      table {
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .table-actions {
        display: flex;
        gap: 6px;
        flex-wrap: nowrap;
        justify-content: center;
        min-width: 200px;
      }
      .table-actions button {
        padding: 6px 10px;
        font-size: 12px;
        min-width: 60px;
        white-space: nowrap;
        flex-shrink: 0;
      }
      .card {
        padding: 14px;
      }
    }
    @media (max-width: 480px){
      .logo {
        font-size: 16px;
      }
      .page-title {
        font-size: 22px;
      }
      .stat .value {
        font-size: 20px;
      }
      .btn {
        padding: 8px 12px;
        font-size: 13px;
      }
      .btn.small {
        padding: 5px 10px;
        font-size: 12px;
      }
      .table-actions button {
        padding: 5px 8px;
        font-size: 11px;
        min-width: 55px;
      }
    }
    .modal-backdrop{
      position:fixed; 
      inset:0; 
      background:rgba(4,12,17,0.4); 
      display:flex;
      align-items:center; 
      justify-content:center; 
      z-index:9999;
      padding: 20px;
    }
    .modal{
      width:90%;
      max-width:400px;
      background:var(--card);
      padding:20px;
      border-radius:16px;
      box-shadow:0 20px 50px rgba(3,20,24,0.3);
      text-align: left;
    }
    .modal input,
    .modal select{
      width:100%;
      padding:10px;
      margin:8px 0 12px;
      border:1px solid #ddd;
      border-radius:8px;
      font-size:14px;
    }
    .modal .field{
      margin-bottom:10px;
    }
    .modal .field label{
      display:block;
      font-weight:600;
      margin-bottom:4px;
      color: var(--accent-text);
    }
    .muted{ color:var(--muted); font-weight:600; }
    .table-actions{ display:flex; gap:6px; flex-wrap: wrap; justify-content: center; }
    .empty-state { text-align: center; padding: 20px; color: var(--muted); }
    footer{ 
      padding:12px 20px; 
      font-size:12px; 
      color:var(--muted); 
      border-top:1px solid rgba(15,23,36,0.04); 
      text-align: center;
      width: 100%;
    }
    #invoiceModal .modal {
      max-width: 700px;
    }
    .invoice-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--turquoise);
    }
    .invoice-title {
      font-size: 22px;
      font-weight: 800;
      color: var(--accent-text);
    }
    .invoice-info div {
      margin: 4px 0;
      font-size: 14px;
    }
    .invoice-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    .invoice-table th,
    .invoice-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    .invoice-table th {
      color: var(--muted);
      font-weight: 600;
    }
    .invoice-total {
      text-align: right;
      margin-top: 16px;
      font-size: 18px;
      font-weight: 700;
    }
    .table-container {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    /* Ensure no horizontal scroll on mobile */
    body {
      overflow-x: hidden;
    }
    .app {
      overflow: hidden;
    }
    /* Button reliability fix */
    .btn, .table-actions button {
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
    }
    .dashboard-chart-container {
      width: 100%;
      height: 280px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 16px;
    }
    .dashboard-chart {
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>
<body>
  <div class="app" id="mainApp">
    <header>
      <div class="logo">
        <!-- Bloomkraft Logo -->
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
          <path d="M2 12C2 6.48 6.48 2 12 2c0 5.52 4.48 10 10 10-5.52 0-10 4.48-10 10C6.48 22 2 17.52 2 12z" fill="#fff" opacity="0.12"></path>
          <path d="M7.6 7.6c2.4 0 5.2 1.4 6.8 3.6 1.6 2.2 2 4.8 1.2 6.4-0.4 0.8-1 1.6-1.8 2.2-0.7-1-2-3-3.6-4.4C8.6 15.4 6.6 14 5.4 12.4 4 10.6 4 8.6 7.6 7.6z" fill="#fff"></path>
        </svg>
        Bloomkraft
      </div>
      <nav class="nav">
        <a href="#" data-page="dashboard" class="active">Dashboard</a>
        <a href="#" data-page="income">Sale</a>
        <a href="#" data-page="expenses">Expenses</a>
      </nav>
    </header>
    <main id="content">
      <!-- DASHBOARD -->
      <section id="page-dashboard" class="page" style="display:block;">
        <h1 class="page-title">Overview</h1>
        <div class="controls">
          <div class="date-filters">
            <label>From:</label>
            <input type="date" id="dashboardFrom" />
            <label>To:</label>
            <input type="date" id="dashboardTo" />
            <button class="btn secondary" id="applyDashboardFilter">Apply</button>
            <button class="btn secondary" id="clearDashboardFilter">Clear</button>
          </div>
        </div>
        <div class="big-stats">
          <div class="stat card"><h4>Total Sale</h4><div class="value" id="totalIncomeEl">MVR 0</div></div>
          <div class="stat card"><h4>Total Expenses</h4><div class="value" id="totalExpensesEl">MVR 0</div></div>
          <div class="stat card"><h4>Net Profit</h4><div class="value" id="netProfitEl">MVR 0</div></div>
        </div>
        <div class="card">
          <h4 class="muted" style="margin:0 0 12px;">Summary (Bar Chart)</h4>
          <div class="dashboard-chart-container">
            <canvas id="summaryBarChart" class="dashboard-chart"></canvas>
          </div>
        </div>
      </section>
      <!-- SALE -->
      <section id="page-income" class="page" style="display:none;">
        <h1 class="page-title">Sale</h1>
        <div class="controls">
          <button class="btn" id="addIncomeBtn">+ Add Sale</button>
          <button class="btn secondary" id="exportIncomeCsv">Export CSV</button>
          <div class="date-filters">
            <label>From:</label>
            <input type="date" id="incomeFrom" />
            <label>To:</label>
            <input type="date" id="incomeTo" />
            <button class="btn secondary" id="applyIncomeFilter">Apply</button>
            <button class="btn secondary" id="clearIncomeFilter">Clear</button>
          </div>
        </div>
        <div class="card">
          <div class="table-container">
            <table id="incomeTable">
              <thead><tr><th>Date</th><th>Description</th><th>Payment</th><th>Amount (MVR)</th><th>Actions</th></tr></thead>
              <tbody></tbody>
              <tfoot><tr><td colspan="3"><strong>Total Sale</strong></td><td id="incomeTotalFooter">MVR 0</td><td></td></tr></tfoot>
            </table>
          </div>
        </div>
      </section>
      <!-- EXPENSES -->
      <section id="page-expenses" class="page" style="display:none;">
        <h1 class="page-title">Expenses</h1>
        <div class="controls">
          <button class="btn" id="addExpenseBtn">+ Add Expense</button>
          <button class="btn secondary" id="exportExpensesCsv">Export CSV</button>
          <div class="date-filters">
            <label>From:</label>
            <input type="date" id="expensesFrom" />
            <label>To:</label>
            <input type="date" id="expensesTo" />
            <button class="btn secondary" id="applyExpensesFilter">Apply</button>
            <button class="btn secondary" id="clearExpensesFilter">Clear</button>
          </div>
        </div>
        <div class="card">
          <div class="table-container">
            <table id="expensesTable">
              <thead><tr><th>Date</th><th>Description</th><th>Payment</th><th>Amount (MVR)</th><th>Actions</th></tr></thead>
              <tbody></tbody>
              <tfoot><tr><td colspan="3"><strong>Total Expenses</strong></td><td id="expensesTotalFooter">MVR 0</td><td></td></tr></tfoot>
            </table>
          </div>
        </div>
      </section>
    </main>
    <footer>Bloomkraft • Business Portal — Currency: MVR</footer>

    <!-- INVOICE MODAL -->
    <div id="invoiceModal" class="modal-backdrop" style="display:none;">
      <div class="modal">
        <button style="float:right; background:none; border:none; font-size:20px; cursor:pointer;" onclick="document.getElementById('invoiceModal').style.display='none'">×</button>
        <div class="invoice-header">
          <div class="invoice-title">Bloomkraft</div>
          <div>Invoice #<span id="invoiceNumber"></span></div>
        </div>
        <div class="invoice-info">
          <div><strong>Date:</strong> <span id="invoiceDate"></span></div>
          <div><strong>Description:</strong> <span id="invoiceDesc"></span></div>
          <div><strong>Payment Method:</strong> <span id="invoicePayment"></span></div>
        </div>
        <table class="invoice-table">
          <thead><tr><th>Description</th><th>Amount (MVR)</th></tr></thead>
          <tbody><tr><td id="invoiceItemDesc"></td><td id="invoiceAmount"></td></tr></tbody>
        </table>
        <div class="invoice-total">Total: <strong><span id="invoiceTotal"></span></strong></div>
        <div class="invoice-footer">Thank you for your business!<br />Currency: MVR</div>
      </div>
    </div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.0/+esm  ';
const supabaseUrl = 'https://skejswjowceevzkloiog.supabase.co  ';
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNrZWpzd2pvd2NlZXZ6a2xvaW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNDg0NDYsImV4cCI6MjA3NjYyNDQ0Nn0.Q9LSKeEkOO7FZv3SOKvJa8efksRfGFYrvZDKlQmKTqk';
const supabase = createClient(supabaseUrl, supabaseAnonKey);

let incomeRecords = [];
let expenseRecords = [];

async function fetchRecords() {
  const [incRes, expRes] = await Promise.all([
    supabase.from('income').select('*').order('date', { ascending: false }),
    supabase.from('expenses').select('*').order('date', { ascending: false })
  ]);
  incomeRecords = incRes.data || [];
  expenseRecords = expRes.data || [];
}

function formatMVR(n) {
  return (Number(n) || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + ' MVR';
}

function isInDateRange(dateStr, filter) {
  if (!filter.from && !filter.to) return true;
  const d = new Date(dateStr);
  if (filter.from && d < new Date(filter.from)) return false;
  if (filter.to && d > new Date(filter.to)) return false;
  return true;
}

function computeTotals(filter = {}) {
  const inc = incomeRecords.filter(r => isInDateRange(r.date, filter));
  const exp = expenseRecords.filter(r => isInDateRange(r.date, filter));
  const totalIncome = inc.reduce((s, r) => s + r.amount, 0);
  const totalExpenses = exp.reduce((s, r) => s + r.amount, 0);
  return { totalIncome, totalExpenses, netProfit: totalIncome - totalExpenses };
}

let summaryBarChart = null;
function renderDashboard() {
  const filter = { from: document.getElementById('dashboardFrom').value, to: document.getElementById('dashboardTo').value };
  const { totalIncome, totalExpenses, netProfit } = computeTotals(filter);
  document.getElementById('totalIncomeEl').textContent = formatMVR(totalIncome);
  document.getElementById('totalExpensesEl').textContent = formatMVR(totalExpenses);
  const netEl = document.getElementById('netProfitEl');
  netEl.textContent = formatMVR(netProfit);
  netEl.style.color = netProfit >= 0 ? 'var(--success)' : 'var(--danger)';

  const ctx = document.getElementById('summaryBarChart')?.getContext('2d');
  if (ctx) {
    if (summaryBarChart) summaryBarChart.destroy();
    summaryBarChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Sale', 'Expenses'],
        datasets: [{ data: [totalIncome, totalExpenses], backgroundColor: ['#2fb6ac', '#ff6b6b'], borderWidth: 0, borderRadius: 6 }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { x: { grid: { display: false } }, y: { beginAtZero: true } }
      }
    });
  }
}

function renderIncome() {
  const tbody = document.querySelector('#incomeTable tbody');
  const filter = { from: document.getElementById('incomeFrom')?.value, to: document.getElementById('incomeTo')?.value };
  const filtered = incomeRecords.filter(r => isInDateRange(r.date, filter));
  tbody.innerHTML = filtered.length
    ? filtered.map(r => `
        <tr data-id="${r.id}" data-type="income">
          <td>${r.date}</td>
          <td>${r.description}</td>
          <td>${r.payment}</td>
          <td style="color:var(--success)">${formatMVR(r.amount)}</td>
          <td class="table-actions">
            <button class="btn small secondary invoice-btn" data-id="${r.id}">Invoice</button>
            <button class="btn small secondary edit-btn" data-id="${r.id}">Edit</button>
            <button class="btn small danger delete-btn" data-id="${r.id}">Delete</button>
          </td>
        </tr>`).join('')
    : `<tr><td colspan="5" class="empty-state">No sale records</td></tr>`;
  const total = filtered.reduce((s, r) => s + r.amount, 0);
  document.getElementById('incomeTotalFooter').textContent = formatMVR(total);
}

function renderExpenses() {
  const tbody = document.querySelector('#expensesTable tbody');
  const filter = { from: document.getElementById('expensesFrom')?.value, to: document.getElementById('expensesTo')?.value };
  const filtered = expenseRecords.filter(r => isInDateRange(r.date, filter));
  tbody.innerHTML = filtered.length
    ? filtered.map(r => `
        <tr data-id="${r.id}" data-type="expense">
          <td>${r.date}</td>
          <td>${r.description}</td>
          <td>${r.payment}</td>
          <td style="color:var(--danger)">${formatMVR(r.amount)}</td>
          <td class="table-actions">
            <button class="btn small secondary edit-btn" data-id="${r.id}">Edit</button>
            <button class="btn small danger delete-btn" data-id="${r.id}">Delete</button>
          </td>
        </tr>`).join('')
    : `<tr><td colspan="5" class="empty-state">No expense records</td></tr>`;
  const total = filtered.reduce((s, r) => s + r.amount, 0);
  document.getElementById('expensesTotalFooter').textContent = formatMVR(total);
}

function generateInvoice(id) {
  const r = incomeRecords.find(rec => rec.id === id);
  if (!r) return;
  const invoiceNum = `INV-${new Date().getTime().toString().slice(-6)}`;
  document.getElementById('invoiceNumber').textContent = invoiceNum;
  document.getElementById('invoiceDate').textContent = r.date;
  document.getElementById('invoiceDesc').textContent = r.description;
  document.getElementById('invoicePayment').textContent = r.payment;
  document.getElementById('invoiceItemDesc').textContent = r.description;
  document.getElementById('invoiceAmount').textContent = formatMVR(r.amount);
  document.getElementById('invoiceTotal').textContent = formatMVR(r.amount);
  document.getElementById('invoiceModal').style.display = 'flex';
}

async function deleteRecord(id, type) {
  if (!confirm(`Delete this ${type}?`)) return;
  const table = type === 'income' ? 'income' : 'expenses';
  const { error } = await supabase.from(table).delete().eq('id', id);
  if (error) alert('Failed to delete');
  else {
    if (type === 'income') {
      incomeRecords = incomeRecords.filter(r => r.id !== id);
      renderIncome();
    } else {
      expenseRecords = expenseRecords.filter(r => r.id !== id);
      renderExpenses();
    }
    renderDashboard();
  }
}

function openEditModal(id, type) {
  const records = type === 'income' ? incomeRecords : expenseRecords;
  const r = records.find(rec => rec.id === id);
  if (!r) return;

  const modal = document.createElement('div');
  modal.className = 'modal-backdrop';
  modal.innerHTML = `
    <div class="modal">
      <button class="close-modal">×</button>
      <h3>Edit ${type === 'income' ? 'Sale' : 'Expense'}</h3>
      <div class="field"><label>Date</label><input type="date" id="m_date" value="${r.date}"></div>
      <div class="field"><label>Description</label><input id="m_desc" value="${r.description}"></div>
      <div class="field"><label>Payment</label>
        <select id="m_pay">
          <option value="Cash" ${r.payment === 'Cash' ? 'selected' : ''}>Cash</option>
          <option value="Transfer" ${r.payment === 'Transfer' ? 'selected' : ''}>Transfer</option>
        </select>
      </div>
      <div class="field"><label>Amount (MVR)</label><input type="number" id="m_amt" value="${r.amount}" step="0.01" min="0"></div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:16px;">
        <button class="btn secondary cancel-btn">Cancel</button>
        <button class="btn save-btn" data-id="${id}" data-type="${type}">Save</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  const closeModal = () => modal.remove();
  modal.querySelector('.close-modal').addEventListener('click', closeModal);
  modal.querySelector('.cancel-btn').addEventListener('click', closeModal);
  modal.querySelector('.save-btn').addEventListener('click', async (e) => {
    const btn = e.target;
    const id = btn.dataset.id;
    const type = btn.dataset.type;
    const date = modal.querySelector('#m_date').value;
    const desc = modal.querySelector('#m_desc').value.trim();
    const payment = modal.querySelector('#m_pay').value;
    const amount = parseFloat(modal.querySelector('#m_amt').value) || 0;
    if (!date || !desc || amount <= 0) {
      alert('Please fill all fields with valid values.');
      return;
    }
    const { error } = await supabase.from(type === 'income' ? 'income' : 'expenses').update({ date, description: desc, payment, amount }).eq('id', id);
    if (!error) {
      const arr = type === 'income' ? incomeRecords : expenseRecords;
      const idx = arr.findIndex(rec => rec.id === id);
      if (idx !== -1) arr[idx] = { ...arr[idx], date, description: desc, payment, amount };
      if (type === 'income') renderIncome(); else renderExpenses();
      renderDashboard();
      closeModal();
    } else alert('Update failed');
  });
}

// ✅ DELEGATED EVENT HANDLER (FIXES MOBILE BUTTONS)
document.getElementById('content').addEventListener('click', (e) => {
  const btn = e.target.closest('.invoice-btn, .edit-btn, .delete-btn');
  if (!btn) return;
  const id = parseInt(btn.dataset.id);
  const row = btn.closest('tr');
  const type = row.dataset.type;
  if (btn.classList.contains('invoice-btn')) generateInvoice(id);
  else if (btn.classList.contains('edit-btn')) openEditModal(id, type);
  else if (btn.classList.contains('delete-btn')) deleteRecord(id, type);
});

// ADD INCOME
document.getElementById('addIncomeBtn')?.addEventListener('click', () => {
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop';
  modal.innerHTML = `
    <div class="modal">
      <button class="close-modal">×</button>
      <h3>Add Sale</h3>
      <div class="field"><label>Date</label><input type="date" id="m_date" value="${new Date().toISOString().slice(0,10)}"></div>
      <div class="field"><label>Description</label><input id="m_desc" placeholder="e.g. Client Payment"></div>
      <div class="field"><label>Payment</label><select id="m_pay"><option>Cash</option><option>Transfer</option></select></div>
      <div class="field"><label>Amount (MVR)</label><input type="number" id="m_amt" value="0" step="0.01" min="0"></div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:16px;">
        <button class="btn secondary cancel-btn">Cancel</button>
        <button class="btn save-new" data-type="income">Add</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  const closeModal = () => modal.remove();
  modal.querySelector('.close-modal').addEventListener('click', closeModal);
  modal.querySelector('.cancel-btn').addEventListener('click', closeModal);
  modal.querySelector('.save-new').addEventListener('click', async () => {
    const date = modal.querySelector('#m_date').value;
    const desc = modal.querySelector('#m_desc').value.trim() || 'Sale';
    const payment = modal.querySelector('#m_pay').value;
    const amount = parseFloat(modal.querySelector('#m_amt').value) || 0;
    if (!date || amount <= 0) { alert('Invalid input'); return; }
    const { data, error } = await supabase.from('income').insert([{ date, description: desc, payment, amount }]).select();
    if (!error) { incomeRecords.unshift(data[0]); renderIncome(); renderDashboard(); closeModal(); }
    else alert('Failed to add');
  });
});

// ADD EXPENSE
document.getElementById('addExpenseBtn')?.addEventListener('click', () => {
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop';
  modal.innerHTML = `
    <div class="modal">
      <button class="close-modal">×</button>
      <h3>Add Expense</h3>
      <div class="field"><label>Date</label><input type="date" id="m_date" value="${new Date().toISOString().slice(0,10)}"></div>
      <div class="field"><label>Description</label><input id="m_desc" placeholder="e.g. Software Subscription"></div>
      <div class="field"><label>Payment</label><select id="m_pay"><option>Cash</option><option>Transfer</option></select></div>
      <div class="field"><label>Amount (MVR)</label><input type="number" id="m_amt" value="0" step="0.01" min="0"></div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:16px;">
        <button class="btn secondary cancel-btn">Cancel</button>
        <button class="btn save-new" data-type="expense">Add</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  const closeModal = () => modal.remove();
  modal.querySelector('.close-modal').addEventListener('click', closeModal);
  modal.querySelector('.cancel-btn').addEventListener('click', closeModal);
  modal.querySelector('.save-new').addEventListener('click', async () => {
    const date = modal.querySelector('#m_date').value;
    const desc = modal.querySelector('#m_desc').value.trim() || 'Expense';
    const payment = modal.querySelector('#m_pay').value;
    const amount = parseFloat(modal.querySelector('#m_amt').value) || 0;
    if (!date || amount <= 0) { alert('Invalid input'); return; }
    const { data, error } = await supabase.from('expenses').insert([{ date, description: desc, payment, amount }]).select();
    if (!error) { expenseRecords.unshift(data[0]); renderExpenses(); renderDashboard(); closeModal(); }
    else alert('Failed to add');
  });
});

// EXPORT
function exportCsv(filename, records) {
  if (!records.length) return alert('No data');
  const headers = ['Date','Description','Payment','Amount'];
  const csv = [headers, ...records.map(r => [r.date, r.description, r.payment, r.amount])]
    .map(row => row.map(v => `"${String(v).replace(/"/g, '""')}"`).join(','))
    .join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), { href: url, download: filename });
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}
document.getElementById('exportIncomeCsv')?.addEventListener('click', () => exportCsv('sale.csv', incomeRecords));
document.getElementById('exportExpensesCsv')?.addEventListener('click', () => exportCsv('expenses.csv', expenseRecords));

// NAVIGATION & FILTERS
document.querySelectorAll('.nav a').forEach(a => {
  a.addEventListener('click', e => {
    e.preventDefault();
    document.querySelectorAll('.nav a').forEach(x => x.classList.remove('active'));
    a.classList.add('active');
    const page = a.dataset.page;
    document.querySelectorAll('.page').forEach(sec => {
      sec.style.display = sec.id === `page-${page}` ? 'block' : 'none';
    });
  });
});

['dashboard','income','expenses'].forEach(p => {
  document.getElementById(`apply${p.charAt(0).toUpperCase() + p.slice(1)}Filter`)?.addEventListener('click', () => {
    p === 'dashboard' ? renderDashboard() : (p === 'income' ? renderIncome() : renderExpenses());
  });
  document.getElementById(`clear${p.charAt(0).toUpperCase() + p.slice(1)}Filter`)?.addEventListener('click', () => {
    document.getElementById(`${p}From`).value = '';
    document.getElementById(`${p}To`).value = '';
    p === 'dashboard' ? renderDashboard() : (p === 'income' ? renderIncome() : renderExpenses());
  });
});

document.getElementById('invoiceModal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('invoiceModal')) {
    document.getElementById('invoiceModal').style.display = 'none';
  }
});

// INIT
(async () => {
  await fetchRecords();
  renderDashboard();
  renderIncome();
  renderExpenses();
})();
</script>
</body>
</html>
```
